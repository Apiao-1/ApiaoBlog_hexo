<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="网易实习的第一个训练项目，抽奖活动后台记录"><meta name="keywords" content="网易,Java,抽奖"><meta name="author" content="Apiao"><meta name="copyright" content="Apiao"><title>SpringMVC 实现抽奖活动（2.Version1 —基于for update悲观锁） | 过客别墅</title><link rel="shortcut icon" href="https://apiao-1258505467.cos.ap-chengdu.myqcloud.com/blog_pic/css_img/favicon.ico"><link rel="stylesheet" href="/blog/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?9e24343494f127f2cc9e8c004fb20cbd";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/blog/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringMVC-实现抽奖活动（2-Version1-—基于for-update悲观锁）"><span class="toc-number">1.</span> <span class="toc-text">SpringMVC 实现抽奖活动（2.Version1 —基于for update悲观锁）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#流程图："><span class="toc-number">1.0.0.1.</span> <span class="toc-text">流程图：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#不足之处："><span class="toc-number">1.0.1.</span> <span class="toc-text">不足之处：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#需求部分"><span class="toc-number">1.0.1.0.1.</span> <span class="toc-text">需求部分</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#代码规范部分"><span class="toc-number">1.0.1.0.2.</span> <span class="toc-text">代码规范部分</span></a></li></ol></li></ol><li class="toc-item toc-level-3"><a class="toc-link" href="#2019-3-16更新"><span class="toc-number">1.0.2.</span> <span class="toc-text">2019.3.16更新</span></a></li></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://apiao-1258505467.cos.ap-chengdu.myqcloud.com/blog_pic/css_img/profile1.jpg"></div><div class="author-info__name text-center">Apiao</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/Apiao-1">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/blog/archives"><span class="pull-left">Articles</span><span class="pull-right">33</span></a><a class="author-info-articles__tags article-meta" href="/blog/tags"><span class="pull-left">Tags</span><span class="pull-right">18</span></a><a class="author-info-articles__categories article-meta" href="/blog/categories"><span class="pull-left">Categories</span><span class="pull-right">2</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://yisaer.github.io/">Yisa</a><a class="author-info-links__name text-center" href="https://me.csdn.net/yr12dong">12dong</a><a class="author-info-links__name text-center" href="http://zouzhitao.github.io">taotao</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://apiao-1258505467.cos.ap-chengdu.myqcloud.com/blog_pic/css_img/article3.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/blog/">Coding Life</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/about">About</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">SpringMVC 实现抽奖活动（2.Version1 —基于for update悲观锁）</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-10-28</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/blog/categories/技术类/">技术类</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">1.5k</span><span class="post-meta__separator">|</span><span>Reading time: 4 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="SpringMVC-实现抽奖活动（2-Version1-—基于for-update悲观锁）"><a href="#SpringMVC-实现抽奖活动（2-Version1-—基于for-update悲观锁）" class="headerlink" title="SpringMVC 实现抽奖活动（2.Version1 —基于for update悲观锁）"></a>SpringMVC 实现抽奖活动（2.Version1 —基于for update悲观锁）</h1><h4 id="流程图："><a href="#流程图：" class="headerlink" title="流程图："></a>流程图：</h4><p><img src="https://apiao-1258505467.cos.ap-chengdu.myqcloud.com/blog_pic/lottery.png" alt="代码流程图"></p>
<p>第一个版本实现的抽奖是保证所有奖品一定能发完的情况（在该场景下只有一个），故每次抽奖的概率不同，会根据剩余用户数与奖品数动态调整（现在整理的时候再看代码的原意真的是惨不忍睹，比如一个map对象命名的后缀是List？？）</p>
<p>核心代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * doLottery</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Transactional</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doLottery</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">       <span class="comment">//获取总的奖品池值</span></span><br><span class="line">       Map&lt;String, Object&gt; configList = configDao.getConfigList().get(<span class="number">0</span>);</span><br><span class="line">       logger.info(<span class="string">"configList: "</span> + configList);</span><br><span class="line">       <span class="comment">/** ----------- 解释1见下文 ----------- **/</span></span><br><span class="line">       <span class="keyword">int</span> totalAward = Integer.parseInt(configList.get(<span class="string">"totalAward"</span>).toString());</span><br><span class="line">       <span class="keyword">int</span> acquiredAward = Integer.parseInt(configList.get(<span class="string">"acquiredAward"</span>).toString());</span><br><span class="line">       <span class="keyword">if</span> (totalAward - acquiredAward &gt; <span class="number">0</span>) &#123; <span class="comment">//奖品有剩余</span></span><br><span class="line">           <span class="comment">//获取中奖范围</span></span><br><span class="line">           <span class="keyword">int</span> awardUpperLimit = Integer.parseInt(configList.get(<span class="string">"awardUpperLimit"</span>).toString());</span><br><span class="line">           <span class="keyword">int</span> totalUpperLimit = Integer.parseInt(configList.get(<span class="string">"totalUpperLimit"</span>).toString());</span><br><span class="line">           <span class="comment">//获取随机数</span></span><br><span class="line">           Random rand = <span class="keyword">new</span> Random();</span><br><span class="line">           <span class="keyword">int</span> random = rand.nextInt(totalUpperLimit); <span class="comment">//用户抽奖，在[0,totalUpperLimit)生成int随机数</span></span><br><span class="line">           <span class="keyword">if</span> (random &lt;= awardUpperLimit &amp;&amp; random &gt;= <span class="number">0</span>) &#123;<span class="comment">//若该数在中奖范围内则说明中奖</span></span><br><span class="line">               res = <span class="number">1</span>; <span class="comment">//中奖</span></span><br><span class="line">               lotteryService.updateAward(acquiredAward + <span class="number">1</span>, awardUpperLimit - <span class="number">1</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               res = -<span class="number">1</span>; <span class="comment">//未中奖</span></span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">/** ----------- 解释2 ----------- **/</span></span><br><span class="line">           configDao.updateProbability(<span class="string">"totalUpperLimit"</span>, totalUpperLimit - <span class="number">1</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123; <span class="comment">//奖品无剩余</span></span><br><span class="line">           res = -<span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       qualifyService.updateStatus(username, res);</span><br><span class="line">       <span class="keyword">return</span> res;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>解释1.<br>在获取配置信息时会有for update加锁（悲观锁，根据主键查询会在主键字段加行锁），在某一时刻只有一个线程可以成功拿到到config信息，保证了之后步骤并发的正确性，即经过此步骤之后所有的并发请求会成串行执行<br><img src="https://apiao-1258505467.cos.ap-chengdu.myqcloud.com/blog_pic/for%20update.png" alt="在这里插入图片描述"></p>
<p>拿出所有的config配置信息，其meta类如下：<br><img src="https://apiao-1258505467.cos.ap-chengdu.myqcloud.com/blog_pic/config%20meta.png" alt="config"></p>
<p>解释2.<br>用户中奖则在数据库中将已获奖品数+ 1,同时将中奖范围-1；若用户未中奖，则将抽奖的上限-1，进而达到动态调整概率的目的，保证最后一个抽奖的用户抽中概率是1（初始的抽奖上限 = 所提供的可抽奖人数）</p>
<h3 id="不足之处："><a href="#不足之处：" class="headerlink" title="不足之处："></a>不足之处：</h3><h5 id="需求部分"><a href="#需求部分" class="headerlink" title="需求部分"></a>需求部分</h5><ul>
<li>此处config中只有一列数据，for update在大部分情况下是行锁，但这里因为数据只有一条就相当于表锁，性能较低，关于for update的相关内容，见<a href="https://blog.csdn.net/claram/article/details/54023216" target="_blank" rel="noopener">https://blog.csdn.net/claram/article/details/54023216</a></li>
<li>确认需求后，应改为抽奖概率固定，即使最后可能没人中奖（很小的概率）</li>
</ul>
<h5 id="代码规范部分"><a href="#代码规范部分" class="headerlink" title="代码规范部分"></a>代码规范部分</h5><ul>
<li>格式化日期不使用SimpleDateFormat（线程不安全），用相关的工具类完成（joda等）</li>
<li>日期转化成Long型时间戳进行存储，比较也要采用时间戳的方式，直接存的话会有日期不唯一的风险,同时存储日期字符串效率低</li>
<li>注意sql语句不能自己拼，有SQL注入的安全风险，要用封装好的方法</li>
<li>代码中别直接用数字/写死的String，不能出现magic number，（要用的时候通过public static final去定义相关的变量）</li>
<li>名称大写的规范：基本数据类型 + public</li>
<li>注意每一个controller的方法（GET/POST/DELETE），区别：get方式一般用于多次访问结果一致的场景，post则用于每次访问返回结果都不尽相同的场景</li>
<li>Controller的访问url用名词，Controller层不要有逻辑层面的判断（除去基本的检测登陆），一般来说controller中只调用一个service层的方法，达到解耦</li>
<li>Dao层只负责返回数据，不去做逻辑处理，对数据的一些筛选/处理可以在Dao完成</li>
<li>除基本数据类型以外的都要判空，注意保护条件(String与meta类)</li>
<li>使用 SLF4J 代替 Log4J 来做 Java 日志</li>
<li>while循环体里边不嵌套dao操作，太耗时</li>
<li>随机数相关用工具类，RandomStringUtils</li>
<li>一大串的判断条件提出一个boolean值，更清晰</li>
<li>用户完成某一操作后，记录数据时最好加上当前的时间戳</li>
<li>sql语句多次相同的话写成一句（多次查询同一张表的不同字段优化成一次全查出来，尽可能减少与数据库的交互）</li>
<li>涉及字符串拼接，String和StringBuffer主要有2个区别：<br>（1）String类对象为不可变对象，一旦你修改了String对象的值，隐性重新创建了一个新的对象，释放原String对象，StringBuffer类对象为可修改对象，可以通过append()方法来修改值<br>（2）String类对象的性能远不如StringBuffer类<br>（3）StringBuffer线程安全，StringBulider不安全，但速度比StringBuffer快。<ul>
<li>@Transaction事物回滚必须在调用的地方捕获RuntimeException</li>
<li>在字符串拼接时要小心中间字符串为null的话，直接就报空指针</li>
<li>object调用toString方法注意若object为null会报NPE</li>
<li>Service层要做好相关的参数合法性验证，一般Dao不再重复做</li>
</ul>
</li>
</ul>
<br>

<h3 id="2019-3-16更新"><a href="#2019-3-16更新" class="headerlink" title="2019.3.16更新"></a>2019.3.16更新</h3><p>昨天阿里一面在说悲观锁版本的时候，对Spring的事务机制有所遗忘，当时想for update 这个语句执行完锁不是释放了吗，怎么保证并发？然后想到所以要把它包在一个事务里边，即通过<code>@Transaction</code>注解。</p>
<p>当时不确定在一个标签内是否就会等跑完这一段事务才释放锁，现贴一个前人做的实验<a href="https://blog.csdn.net/qiuhan/article/details/51179808" target="_blank" rel="noopener">数据库中for update的使用</a>，证实@Transaction作用和数据库中的开始事务类似，而在代码结束之后会自动提交，因此如果在代码中加了for update的锁，这个锁会持续整个事务的生命周期。</p>
<blockquote>
<p>这也是为什么不推荐使用for update的原因，1.若在里面对多个资源加了锁，容易导致死锁；2.性能低，其实质是对索引加的锁，因此其他的地方如果想要通过这个索引获得别的行的数据也是会被阻塞的</p>
</blockquote>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Apiao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://Apiao-1.github.io/blog/2018/10/28/2018-10-28/">https://Apiao-1.github.io/blog/2018/10/28/2018-10-28/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/blog/tags/网易/">网易</a><a class="post-meta__tags" href="/blog/tags/Java/">Java</a><a class="post-meta__tags" href="/blog/tags/抽奖/">抽奖</a></div><div class="social-share" data-disabled="diandian,google,facebook,twitter,douban,share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/blog/2018/11/01/2018-11-01/"><i class="fa fa-chevron-left">  </i><span>SpringMVC 实现抽奖活动（3.优化—乐观锁实现Version2）</span></a></div><div class="next-post pull-right"><a href="/blog/2018/10/25/2018-10-25/"><span>SpringMVC 实现抽奖活动（1.设计部分）</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '6b935e9520902dc3254e',
  clientSecret: 'b571d293c4bec714f696e962f7f7c39439abe533',
  repo: 'ApiaoBlog_hexo',
  owner: 'q827926435',
  admin: 'q827926435',
  id: md5(decodeURI(location.pathname)),
  language: ''
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(https://apiao-1258505467.cos.ap-chengdu.myqcloud.com/blog_pic/css_img/article3.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2020 By Apiao</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">一直寻找道路的人最后会架起桥梁</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/blog/js/utils.js?version=1.6.1"></script><script src="/blog/js/fancybox.js?version=1.6.1"></script><script src="/blog/js/sidebar.js?version=1.6.1"></script><script src="/blog/js/copy.js?version=1.6.1"></script><script src="/blog/js/fireworks.js?version=1.6.1"></script><script src="/blog/js/transition.js?version=1.6.1"></script><script src="/blog/js/scroll.js?version=1.6.1"></script><script src="/blog/js/head.js?version=1.6.1"></script><script src="/blog/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>